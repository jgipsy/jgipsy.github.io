{"head":{"title":"Redis high availavility installation","date":"2017-03-01T00:00:00.000Z","layout":"Post","hero":"../../assets/hands.svg","description":"Cookbook to install redis in high availability in master-slave tipology Install redis in a host &lt;APP_SERVER_1_IP> Fill form Configureâ€¦"},"body":"<p>Cookbook to install redis in high availability in master-slave tipology</p>\n<h1 id=\"install-redis-in-a-host-app_server_1_ip\"><a href=\"#install-redis-in-a-host-app_server_1_ip\" class=\"phenomic-HeadingAnchor\">#</a>Install redis in a host &#x3C;APP_SERVER_1_IP></h1>\n<pre><code class=\"hljs language-shell\">wget http:<span class=\"hljs-comment\">//download.redis.io/releases/redis-3.2.8.tar.gz</span>\ntar xzf redis-3.2.8.tar.gz\n<span class=\"hljs-keyword\">cd</span> redis-3.2.8/\nmake\n<span class=\"hljs-keyword\">cd</span> utils\nsudo ./install_server.<span class=\"hljs-keyword\">sh</span></code></pre>\n<h1 id=\"fill-form\"><a href=\"#fill-form\" class=\"phenomic-HeadingAnchor\">#</a>Fill form</h1>\n<pre><code class=\"hljs language-shell\"><span class=\"hljs-string\">Port           :</span> <span class=\"hljs-number\">6379</span>\nConfig <span class=\"hljs-string\">file    :</span> <span class=\"hljs-regexp\">/etc/</span>redis/redis_6379.conf\nLog <span class=\"hljs-string\">file       :</span> <span class=\"hljs-regexp\">/var/</span>log/redis_6379.log\nData <span class=\"hljs-string\">dir       :</span> <span class=\"hljs-regexp\">/var/</span>lib<span class=\"hljs-regexp\">/redis/</span><span class=\"hljs-number\">6379</span>\n<span class=\"hljs-string\">Executable     :</span> <span class=\"hljs-regexp\">/home/</span>vagrant<span class=\"hljs-regexp\">/redis-3.2.8/</span>src/redis-server\nCli <span class=\"hljs-string\">Executable :</span> <span class=\"hljs-regexp\">/home/</span>vagrant<span class=\"hljs-regexp\">/redis-3.2.8/</span>src/redis-clii</code></pre>\n<h1 id=\"configure-redis_6379conf-with-next-configuration\"><a href=\"#configure-redis_6379conf-with-next-configuration\" class=\"phenomic-HeadingAnchor\">#</a>Configure redis_6379.conf with next configuration</h1>\n<pre><code class=\"hljs language-shell\">bind &#x3C;APP_SERVER_1_IP> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>\nport <span class=\"hljs-number\">6379</span>\nslave-priority <span class=\"hljs-number\">1</span></code></pre>\n<h1 id=\"create-sentinelconf-file\"><a href=\"#create-sentinelconf-file\" class=\"phenomic-HeadingAnchor\">#</a>Create sentinel.conf file</h1>\n<pre><code class=\"hljs language-shell\">bind &#x3C;APP_SERVER_1_IP>\nsentinel<span class=\"hljs-built_in\"> monitor </span>redismaster &#x3C;APP_SERVER_1_IP> 6379 2  \nsentinel down-after-milliseconds redismaster 6000 \ndaemonize yes\nloglevel verbose\nlogfile <span class=\"hljs-string\">\"/var/log/sentinel.log\"</span>\npidfile <span class=\"hljs-string\">\"/var/run/redis_26379.pid\"</span></code></pre>\n<h1 id=\"start-sentinel\"><a href=\"#start-sentinel\" class=\"phenomic-HeadingAnchor\">#</a>Start sentinel</h1>\n<pre><code class=\"hljs language-shell\">sudo ./install_server<span class=\"hljs-selector-class\">.sh</span>\n<span class=\"hljs-comment\">/*nohup ./redis-server /home/vagrant/redis-3.2.8/utils/sentinel.conf --sentinel &#x26;*/</span></code></pre>\n<h1 id=\"change-etcinitdredis_26379\"><a href=\"#change-etcinitdredis_26379\" class=\"phenomic-HeadingAnchor\">#</a>Change /etc/init.d/redis_26379</h1>\n<pre><code class=\"hljs language-shell\"><span class=\"hljs-meta\">#!/bin/sh</span>\n<span class=\"hljs-comment\">#Configurations injected by install_server below....</span>\n\nEXEC=/home/vagrant/redis-3.2.8/src/redis-server\nCLIEXEC=/home/vagrant/redis-3.2.8/src/redis-cli\nPIDFILE=/var/run/redis_26379.pid\nCONF=<span class=\"hljs-string\">\"/etc/redis/sentinel.conf\"</span>\nREDISPORT=<span class=\"hljs-string\">\"26379\"</span>\nLOGFILE=<span class=\"hljs-string\">\"/var/log/sentinel.log\"</span>\n<span class=\"hljs-comment\">###############</span>\n<span class=\"hljs-comment\"># SysV Init Information</span>\n<span class=\"hljs-comment\"># chkconfig: - 58 74</span>\n<span class=\"hljs-comment\"># description: redis_26379 is the redis daemon.</span>\n<span class=\"hljs-comment\">### BEGIN INIT INFO</span>\n<span class=\"hljs-comment\"># Provides: redis_26379</span>\n<span class=\"hljs-comment\"># Required-Start: $network $local_fs $remote_fs</span>\n<span class=\"hljs-comment\"># Required-Stop: $network $local_fs $remote_fs</span>\n<span class=\"hljs-comment\"># Default-Start: 2 3 4 5</span>\n<span class=\"hljs-comment\"># Default-Stop: 0 1 6</span>\n<span class=\"hljs-comment\"># Should-Start: $syslog $named</span>\n<span class=\"hljs-comment\"># Should-Stop: $syslog $named</span>\n<span class=\"hljs-comment\"># Short-Description: start and stop redis_26379</span>\n<span class=\"hljs-comment\"># Description: Redis daemon</span>\n<span class=\"hljs-comment\">### END INIT INFO</span>\n\n\n<span class=\"hljs-keyword\">case</span> <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$1</span>\"</span> <span class=\"hljs-keyword\">in</span>\n    start)\n        <span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-_\">-f</span> <span class=\"hljs-variable\">$PIDFILE</span> ]\n        <span class=\"hljs-keyword\">then</span>\n            <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$PIDFILE</span> exists, process is already running or crashed\"</span>\n        <span class=\"hljs-keyword\">else</span>\n            <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"Starting Redis server...\"</span>\n            <span class=\"hljs-variable\">$EXEC</span> <span class=\"hljs-variable\">$CONF</span> --sentinel\n        <span class=\"hljs-keyword\">fi</span>\n        ;;\n    stop)\n        <span class=\"hljs-keyword\">if</span> [ ! <span class=\"hljs-_\">-f</span> <span class=\"hljs-variable\">$PIDFILE</span> ]\n        <span class=\"hljs-keyword\">then</span>\n            <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$PIDFILE</span> does not exist, process is not running\"</span>\n        <span class=\"hljs-keyword\">else</span>\n            PID=$(cat <span class=\"hljs-variable\">$PIDFILE</span>)\n            <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"Stopping ...\"</span>\n            <span class=\"hljs-built_in\">kill</span> -9 <span class=\"hljs-variable\">$PID</span>\n            rm <span class=\"hljs-variable\">$PIDFILE</span>\n            <span class=\"hljs-keyword\">while</span> [ -x /proc/<span class=\"hljs-variable\">${PID}</span> ]\n            <span class=\"hljs-keyword\">do</span>\n                <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"Waiting for Redis to shutdown ...\"</span>\n                sleep 1\n            <span class=\"hljs-keyword\">done</span>\n            <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"Redis stopped\"</span>\n        <span class=\"hljs-keyword\">fi</span>\n        ;;\n    status)\n        PID=$(cat <span class=\"hljs-variable\">$PIDFILE</span>)\n        <span class=\"hljs-keyword\">if</span> [ ! -x /proc/<span class=\"hljs-variable\">${PID}</span> ]\n        <span class=\"hljs-keyword\">then</span>\n            <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">'Redis is not running'</span>\n        <span class=\"hljs-keyword\">else</span>\n            <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"Redis is running (<span class=\"hljs-variable\">$PID</span>)\"</span>\n        <span class=\"hljs-keyword\">fi</span>\n        ;;\n    restart)\n        <span class=\"hljs-variable\">$0</span> stop\n        <span class=\"hljs-variable\">$0</span> start\n        ;;\n    *)\n        <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"Please use start, stop, restart or status as first argument\"</span>\n        ;;\n<span class=\"hljs-keyword\">esac</span></code></pre>\n<h1 id=\"install-redis-in-another-host-app_server_2_ip\"><a href=\"#install-redis-in-another-host-app_server_2_ip\" class=\"phenomic-HeadingAnchor\">#</a>Install redis in another host &#x3C;APP_SERVER_2_IP></h1>\n<pre><code class=\"hljs language-shell\">wget http:<span class=\"hljs-comment\">//download.redis.io/releases/redis-3.2.8.tar.gz</span>\ntar xzf redis-3.2.8.tar.gz\n<span class=\"hljs-keyword\">cd</span> redis-3.2.8/\nmake\n<span class=\"hljs-keyword\">cd</span> utils\nsudo ./install_server.<span class=\"hljs-keyword\">sh</span></code></pre>\n<h1 id=\"fill-form-1\"><a href=\"#fill-form-1\" class=\"phenomic-HeadingAnchor\">#</a>Fill form</h1>\n<pre><code class=\"hljs language-shell\"><span class=\"hljs-string\">Port           :</span> <span class=\"hljs-number\">6379</span>\nConfig <span class=\"hljs-string\">file    :</span> <span class=\"hljs-regexp\">/etc/</span>redis/<span class=\"hljs-number\">6379.</span>conf\nLog <span class=\"hljs-string\">file       :</span> <span class=\"hljs-regexp\">/var/</span>log/redis_6379.log\nData <span class=\"hljs-string\">dir       :</span> <span class=\"hljs-regexp\">/var/</span>lib<span class=\"hljs-regexp\">/redis/</span><span class=\"hljs-number\">6379</span>\n<span class=\"hljs-string\">Executable     :</span> <span class=\"hljs-regexp\">/home/</span>vagrant<span class=\"hljs-regexp\">/redis-3.2.8/</span>src/redis-server\nCli <span class=\"hljs-string\">Executable :</span> <span class=\"hljs-regexp\">/home/</span>vagrant<span class=\"hljs-regexp\">/redis-3.2.8/</span>src/redis-cli</code></pre>\n<h1 id=\"configure-redis_6379conf-with-next-configuration-1\"><a href=\"#configure-redis_6379conf-with-next-configuration-1\" class=\"phenomic-HeadingAnchor\">#</a>Configure redis_6379.conf with next configuration</h1>\n<pre><code class=\"hljs language-shell\">bind &#x3C;APP_SERVER_2_IP>\nport <span class=\"hljs-number\">6379</span>\nslave-priority <span class=\"hljs-number\">10</span>\nslaveof &#x3C;APP_SERVER_1_IP> <span class=\"hljs-number\">6379</span></code></pre>\n<h1 id=\"create-sentinelconf-file-1\"><a href=\"#create-sentinelconf-file-1\" class=\"phenomic-HeadingAnchor\">#</a>Create sentinel.conf file</h1>\n<pre><code class=\"hljs language-shell\">bind &#x3C;APP_SERVER_2_IP>\nsentinel<span class=\"hljs-built_in\"> monitor </span>redismaster &#x3C;APP_SERVER_2_IP> 6379 2  \nsentinel down-after-milliseconds redismaster 6000</code></pre>\n<h1 id=\"start-sentinel-1\"><a href=\"#start-sentinel-1\" class=\"phenomic-HeadingAnchor\">#</a>Start sentinel</h1>\n<pre><code class=\"hljs language-shell\">sudo ./install_server<span class=\"hljs-selector-class\">.sh</span>\n<span class=\"hljs-comment\">/*nohup ./redis-server /etc/redis/sentinel.conf --sentinel &#x26;*/</span></code></pre>\n<h1 id=\"install-sentinel-in-a-host-app_server_3_ip\"><a href=\"#install-sentinel-in-a-host-app_server_3_ip\" class=\"phenomic-HeadingAnchor\">#</a>Install sentinel in a host &#x3C;APP_SERVER_3_IP></h1>\n<pre><code class=\"hljs language-shell\">wget http:<span class=\"hljs-comment\">//download.redis.io/releases/redis-3.2.8.tar.gz</span>\ntar xzf redis-3.2.8.tar.gz\n<span class=\"hljs-keyword\">cd</span> redis-3.2.8/\nmake\n<span class=\"hljs-keyword\">cd</span> utils\nsudo ./install_server.<span class=\"hljs-keyword\">sh</span></code></pre>\n<h1 id=\"configure-sentinelconf\"><a href=\"#configure-sentinelconf\" class=\"phenomic-HeadingAnchor\">#</a>Configure sentinel.conf</h1>\n<pre><code class=\"hljs language-shell\">bind &#x3C;APP_SERVER_3_IP>\nsentinel<span class=\"hljs-built_in\"> monitor </span>redismaster &#x3C;APP_SERVER_3_IP> 6379 2</code></pre>\n<h1 id=\"start-sentinel-2\"><a href=\"#start-sentinel-2\" class=\"phenomic-HeadingAnchor\">#</a>Start sentinel</h1>\n<pre><code class=\"hljs language-shell\">sudo ./install_server<span class=\"hljs-selector-class\">.sh</span>\n<span class=\"hljs-comment\">/*nohup ./redis-server /home/vagrant/redis-3.2.8/sentinel.conf --sentinel &#x26;*/</span></code></pre>\n<h1 id=\"knowed-bugs\"><a href=\"#knowed-bugs\" class=\"phenomic-HeadingAnchor\">#</a>Knowed bugs</h1>\n<h2 id=\"if-you-see-in-log\"><a href=\"#if-you-see-in-log\" class=\"phenomic-HeadingAnchor\">#</a>If you see in log:</h2>\n<pre><code class=\"hljs language-shell\"><span class=\"hljs-number\">7137</span>:S <span class=\"hljs-number\">14</span> Mar <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">22</span>:<span class=\"hljs-number\">14.347</span> * Retrying <span class=\"hljs-keyword\">with</span> SYNC...\n<span class=\"hljs-number\">7137</span>:S <span class=\"hljs-number\">14</span> Mar <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">22</span>:<span class=\"hljs-number\">14.347</span> # MASTER aborted replication <span class=\"hljs-keyword\">with</span> an <span class=\"hljs-literal\">error</span>: ERR Can<span class=\"hljs-symbol\">'t</span> SYNC <span class=\"hljs-keyword\">while</span> <span class=\"hljs-keyword\">not</span> connected <span class=\"hljs-keyword\">with</span> my master\n<span class=\"hljs-number\">7137</span>:S <span class=\"hljs-number\">14</span> Mar <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">22</span>:<span class=\"hljs-number\">15.348</span> * Connecting <span class=\"hljs-keyword\">to</span> MASTER &#x3C;APP_SERVER_1_IP>:<span class=\"hljs-number\">6379</span>\n<span class=\"hljs-number\">7137</span>:S <span class=\"hljs-number\">14</span> Mar <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">22</span>:<span class=\"hljs-number\">15.349</span> * MASTER &#x3C;-> SLAVE sync started\n<span class=\"hljs-number\">7137</span>:S <span class=\"hljs-number\">14</span> Mar <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">22</span>:<span class=\"hljs-number\">15.349</span> * Non blocking connect <span class=\"hljs-keyword\">for</span> SYNC fired the event.\n<span class=\"hljs-number\">7137</span>:S <span class=\"hljs-number\">14</span> Mar <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">22</span>:<span class=\"hljs-number\">15.350</span> * Master replied <span class=\"hljs-keyword\">to</span> PING, replication can continue...\n<span class=\"hljs-number\">7137</span>:S <span class=\"hljs-number\">14</span> Mar <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">22</span>:<span class=\"hljs-number\">15.350</span> * Partial resynchronization <span class=\"hljs-keyword\">not</span> possible (no cached master)\n<span class=\"hljs-number\">7137</span>:S <span class=\"hljs-number\">14</span> Mar <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">22</span>:<span class=\"hljs-number\">15.351</span> * Master does <span class=\"hljs-keyword\">not</span> support PSYNC <span class=\"hljs-keyword\">or</span> <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">in</span> <span class=\"hljs-literal\">error</span> state (reply: -ERR Can<span class=\"hljs-symbol\">'t</span> SYNC <span class=\"hljs-keyword\">while</span> <span class=\"hljs-keyword\">not</span> connected <span class=\"hljs-keyword\">with</span> my master)</code></pre>\n<p>You need to connect to redis-cli and execute this commands:</p>\n<pre><code class=\"hljs language-shell\">CONFIG <span class=\"hljs-keyword\">SET</span> <span class=\"hljs-keyword\">slave</span>-serve-stale-<span class=\"hljs-keyword\">data</span> yes\nSLAVEOF <span class=\"hljs-keyword\">NO</span> ONE\nCONFIG <span class=\"hljs-keyword\">SET</span> <span class=\"hljs-keyword\">slave</span>-serve-stale-<span class=\"hljs-keyword\">data</span> <span class=\"hljs-keyword\">no</span></code></pre>\n<h1 id=\"cli-command-utils\"><a href=\"#cli-command-utils\" class=\"phenomic-HeadingAnchor\">#</a>cli command utils</h1>\n<pre><code class=\"hljs language-shell\">/home/vagrant/redis-3.2.8/src/redis-cli\n\nTo see node role\n\nINFO Replication\n\nTo see all stored data in <span class=\"hljs-keyword\">cache</span>\n\n<span class=\"hljs-keyword\">KEYS</span> *\n\n<span class=\"hljs-keyword\">To</span> see all ordered <span class=\"hljs-keyword\">keys</span> \n\nZRANGE contactData~<span class=\"hljs-keyword\">keys</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">-1</span> WITHSCORES\n\n<span class=\"hljs-keyword\">To</span> <span class=\"hljs-keyword\">get</span> <span class=\"hljs-keyword\">value</span> <span class=\"hljs-keyword\">of</span> one <span class=\"hljs-keyword\">key</span>\n\n<span class=\"hljs-keyword\">GET</span> <span class=\"hljs-string\">\"&#x3C;&#x3C;key>>\"</span></code></pre>\n<p>Reference: <a href=\"http://enmilocalfunciona.io/configuracion-basica-de-un-cluster-redis-sentinel-bajo-unix/\">http://enmilocalfunciona.io/configuracion-basica-de-un-cluster-redis-sentinel-bajo-unix/</a></p>\n","__filename":"posts/redis-installation.md","__url":"/posts/redis-installation/","__resourceUrl":"/posts/redis-installation/index.html","__dataUrl":"/posts/redis-installation/index.html.1c7e1f8276cbcd677810934c104a103f.json"}